window.Funnelback||(window.Funnelback={}),Element.prototype.matches||(Element.prototype.matches=Element.prototype.msMatchesSelector||Element.prototype.webkitMatchesSelector),Element.prototype.closest||(Element.prototype.closest=function(e){var t=this;do{if(t.matches(e))return t;t=t.parentElement||t.parentNode}while(null!==t&&1===t.nodeType);return null}),Object.entries||(Object.entries=function(e){for(var t=Object.keys(e),n=t.length,l=new Array(n);n--;)l[n]=[t[n],e[t[n]]];return l}),window.Funnelback.SessionCart=function(){"use strict";var e=function(e){return this.init(e)};e.defaults={apiBase:"/s/cart.json",collection:null,iconPrefix:"glyphicon glyphicon-",cart:{selector:"#search-cart",pageSelector:["#search-results-content","#search-history"],icon:"pushpin",label:"Saved",backIcon:"arrow-left",backLabel:"Back to results",clearClasses:"btn btn-xs btn-danger",clearIcon:"remove",clearLabel:"Clear",templateSelector:"#cart-template",emptyMessage:'<span id="flb-cart-empty-message">No items</span>'},cartCount:{selector:".flb-cart-count",icon:"shopping-cart",isLabel:!1,label:"cart",template:"{{>icon-block}} {{>label-block}} {{>badge-block}}"},item:{selector:"#search-results",templates:{default:'<h4><a href="{{indexUrl}}">{{#truncate 70}}{{title}}{{/truncate}}</a></h4><cite class="text-success">{{#cut "https://"}}{{indexUrl}}{{/cut}}</cite><p>{{#truncate 255}}{{summary}}{{/truncate}}</p>'},class:""},itemTrigger:{selector:"h4",position:"afterbegin",class:"",iconAdd:"pushpin",iconDelete:"remove",isLabel:!1,labelAdd:"Add to cart",labelDelete:"Remove from cart",template:"{{>icon-block}} {{>label-block}}"},cartItemTrigger:{},resultItemTrigger:{}},e.prototype.Handlebars=Handlebars.create(),e.prototype.init=function(c){return c.collection?((e.options=i.extend(e.defaults,c||{})).cart.pageSelector||(e.options.cart.pageSelector=[]),e.options.cartItemTrigger=i.extend(i.extend({},e.options.itemTrigger),e.options.cartItemTrigger),e.options.resultItemTrigger=i.extend(i.extend({},e.options.itemTrigger),e.options.resultItemTrigger),n.init(e.options),l.init(e.options),o.init(e.options),a.init(e.options),r.set(e.options),t.get(e.options).then(function(t){r.update(e.options,t.data),l.set(t.data.length),n.toggleClearElement(t.data)}).catch(function(e){console.error("Something went wrong and no data was fetched. Try again later..",e)}),this):(console.error('Missing "collection" parameter'),null)},e.prototype.clear=function(){if(!0===confirm("Your selection will be cleared")){const o=this.getOption();t.delete(o).then(function(t){r.clear(o),l.set(t.data.length),n.toggleClearElement(t.data),e.prototype.hide()}).catch(function(e){console.error("Something went wrong and cart was not cleared. Try again later..",e)})}return this},e.prototype.destroy=function(){return e.options={},null},e.prototype.show=function(){return n.element.style.display="block",n.togglePageElements("none"),n.isHidden=!1,this},e.prototype.hide=function(){return n.element.style.display="none",n.togglePageElements("block"),n.isHidden=!0,this},e.prototype.toggle=function(){return n.isHidden?e.prototype.show():e.prototype.hide()},e.prototype.getOption=function(t){return 0===arguments.length?e.options:"string"==typeof t?e.options[t]:void 0},e.prototype.addItem=function(e){const r=this.getOption();t.post(r,{url:e}).then(function(t){o.update(r,t.data.filter(function(t){return t.indexUrl===e})[0],"del"),l.set(t.data.length),n.toggleClearElement(t.data)}).catch(function(e){console.error("Something went wrong and item was not saved in a cart. Try again later..",e)})},e.prototype.deleteItem=function(e){const r=this.getOption();t.delete(r,{url:e}).then(function(t){o.update(r,{indexUrl:e},"add"),l.set(t.data.length),n.toggleClearElement(t.data)}).catch(function(e){console.error("Something went wrong and result was not removed from a cart. Try again later..",e)})};const t={delete:function(e,n){return t.request("delete",e,n)},get:function(e,n){return t.request("get",e,n)},post:function(e,n){return t.request("post",e,n)},request:function(e,n,l){return new Promise(function(o,r){const a=new XMLHttpRequest,c=t.getUrl(n,l);a.withCredentials=!0,a.onload=function(){if(200!==this.status)r({url:c,error:this});else try{const e=JSON.parse(this.responseText);o({url:c,data:e})}catch(e){r({url:c,error:e})}},a.onerror=function(){r({url:c,error:a})},a.open(e,c,!0),a.setRequestHeader("Accept","application/json"),a.setRequestHeader("Content-Type","text/plain"),a.send(JSON.stringify(l||{}))})},getParamsString:function(e){const t=[];for(var n in e)e.hasOwnProperty(n)&&t.push(encodeURIComponent(n)+"="+encodeURIComponent(e[n]));return t.join("&")},getUrl:function(e,n){return n||(n={}),n.collection=e.collection,e.apiBase+"?"+t.getParamsString(n)}},n={element:null,clearElement:null,listElement:null,pageElements:[],modifiedPageElements:null,isHidden:!0,emptyMessage:null,init:function(t){n.element=c.findOnce(t.cart.selector),n.element||console.warn(`No element was found with provided selector "${t.cart.selector}"`),n.element.style.display="none",n.emptyMessage=t.cart.emptyMessage;for(var l=0,o=t.cart.pageSelector.length;l<o;l++){const e=c.findOnce(t.cart.pageSelector[l]);e&&n.pageElements.push(e)}n.pageElements.length||console.warn(`No element was found with provided page selector "${t.cart.pageSelector}"`);const r=t.cart.backIcon?t.iconPrefix+t.cart.backIcon:null,a=t.cart.icon?t.iconPrefix+t.cart.icon:null,i=t.cart.clearIcon?t.iconPrefix+t.cart.clearIcon:null;document.querySelector(t.cart.templateSelector)||console.warn(`No element was found with the provided selector "${t.cart.templateSelector}"`);const d=s.compile(document.querySelector(t.cart.templateSelector).text);document.getElementById("search-cart").innerHTML=d({backIcon:r,headerIcon:a,clearIcon:i,backLabel:t.cart.backLabel,label:t.cart.label,clearLabel:t.cart.clearLabel}),n.clearElement=document.getElementById("flb-cart-box-clear"),n.clearElement.addEventListener("click",function(){e.prototype.clear(t)}),document.getElementById("flb-cart-box-back").addEventListener("click",e.prototype.hide),n.listElement=document.getElementById("flb-cart-box-list")},toggleClearElement:function(e){e.length>0?n.clearElement.style.display="inline-block":(n.listElement.innerHTML=n.emptyMessage,n.clearElement.style.display="none")},togglePageElements:function(e){n.modifiedPageElements&&"none"!==e||(n.modifiedPageElements=n.pageElements);const t=[];for(var l=0,o=n.pageElements.length;l<o;l++){const o=n.pageElements[l];-1!==n.modifiedPageElements.indexOf(o)&&o.style.display!==e&&(o.style.display=e,t.push(o))}n.modifiedPageElements=t}},l={selector:"flb-cart-count-trigger",element:null,icon:null,label:null,partialTitle:" items",template:null,init:function(t){t.cartCount.icon&&(l.icon=t.iconPrefix+t.cartCount.icon),t.cartCount.isLabel&&(l.label=t.cartCount.label),t.cartCount.label&&(l.partialTitle+=" in your "+t.cartCount.label.toLowerCase()),l.template=s.compile(t.cartCount.template),l.element=c.create(l.selector,c.findOnce(t.cartCount.selector),"button",l.template(l.data(0)),{class:"btn-link",type:"button",tabindex:"0",title:l.title(0)}),c.addEvent(l.element,"click",e.prototype.toggle)},data:function(e){return{count:e,icon:l.icon,label:l.label}},set:function(e){c.setContent(l.element,l.template(l.data(e))),l.element.setAttribute("title",l.title(e)),l.element.closest("button").disabled=0===e},title:function(e){return e+l.partialTitle}},o={selectorAttr:"data-fb-result",listElement:null,templates:null,init:function(e){o.templates=Object.entries(e.item.templates).reduce(function(e,[t,n]){return e[t]=s.compile(n),e}),o.listElement=c.findOnce(e.item.selector),o.listElement||console.warn('No element was found with provided selector "'+e.item.selector+'"')},selector:function(e){return e?"["+o.selectorAttr+'="'+e+'"]':"["+o.selectorAttr+"]"},update:function(e,t,l){const r=c.findOnce(o.selector(t.indexUrl),o.listElement);if(r&&a.update("result",r,l),"add"===l){const e=c.findOnce(o.selector(t.indexUrl),n.listElement);c.remove(e)}else{const l={};e.item.class&&(l.class=e.item.class),l[o.selectorAttr]=t.indexUrl;const r=o.templates[t.collection]?o.templates[t.collection]:o.templates.default,i=c.create("flb-cart-box-item",null,"li",r(t),l);a.set("cart",e.cartItemTrigger,i),a.update("cart",i);const s=document.getElementById("flb-cart-empty-message");s&&s.parentNode.removeChild(s),n.listElement.insertAdjacentElement("afterbegin",i)}}},r={clear:function(e){n.listElement.innerHTML=n.emptyMessage;const t=c.find(o.selector(),o.listElement);for(var l=0,r=t.length;l<r;l++)a.update("result",t[l],"add")},set:function(e){const t=c.find(o.selector(),o.listElement);for(var n=t.length-1;n>=0;n--)a.set("result",e.resultItemTrigger,t[n])},update:function(e,t,l){for(var r=0,a=t.length;r<a;r++)o.update(e,t[r],l);t.length||(n.listElement.innerHTML=n.emptyMessage)}},a={selector:"flb-cart-item-trigger",addEvent:null,delEvent:null,cartAddTemplate:null,cartAddTitle:null,cartDelTemplate:null,cartDelTitle:null,resultAddTemplate:null,resultAddTitle:null,resultDelTemplate:null,resultDelTitle:null,init:function(t){function n(e,n){const l=s.compile(n.template);a[e+"AddTemplate"]=l({icon:t.iconPrefix+n.iconAdd,label:n.isLabel?n.labelAdd:null}),a[e+"DelTemplate"]=l({icon:t.iconPrefix+n.iconDelete,label:n.isLabel?n.labelDelete:null}),a[e+"AddTitle"]=n.labelAdd,a[e+"DelTitle"]=n.labelDelete}n("cart",t.cartItemTrigger),n("result",t.resultItemTrigger),a.addEvent=function(t){t.preventDefault();const n=t.currentTarget.closest(o.selector()).getAttribute(o.selectorAttr);if(n)return e.prototype.addItem(n);console.warn("No URL found to save item in a cart")},a.delEvent=function(t){t.preventDefault();const n=t.currentTarget.closest(o.selector()).getAttribute(o.selectorAttr);if(n)return e.prototype.deleteItem(n);console.warn("No URL found to remove result from a cart")}},set:function(e,t,n){const l=c.findOnce(t.selector,n),o=c.create(a.selector,null,"button",a[e+"AddTemplate"],{class:t.class,title:a[e+"AddTitle"],type:"button",tabindex:"0"});c.addEvent(o,"click",a.addEvent),l?l.insertAdjacentElement(t.position,o):console.info('No element was found with provided selector "'+t.selector+'"')},update:function(e,t,n){const l=c.findOnce("."+a.selector,t);"add"===n?(c.setContent(l,a[e+"AddTemplate"]),c.removeEvent(l,"click",a.delEvent),c.addEvent(l,"click",a.addEvent),l.setAttribute("title",a[e+"AddTitle"])):(c.setContent(l,a[e+"DelTemplate"]),c.removeEvent(l,"click",a.addEvent),c.addEvent(l,"click",a.delEvent),l.setAttribute("title",a[e+"DelTitle"]))}},c={create:function(e,t,n,l,o){const r=document.createElement(n||"div");return l&&c.setContent(r,l),o||(o={}),o.class?o.class+=" "+e:o.class=e,c.setAttr(r,o),t&&t.appendChild(r),r},remove:function(e){e?e.parentNode.removeChild(e):console.warn("Remove called on element which could not be found")},find:function(e,t){return t||(t=document),t.querySelectorAll(e)},findOnce:function(e,t){return c.find(e,t)[0]},setAttr:function(e,t){const n=Object.entries(t);for(var l=0,o=n.length;l<o;l++)e.setAttribute(n[l][0],n[l][1])},setContent:function(e,t){e.innerHTML=t},addEvent:function(e,t,n){e.addEventListener(t,n)},removeEvent:function(e,t,n){e.removeEventListener(t,n)}},i={extend:function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]="object"==typeof t[n]?i.extend(e[n]||{},t[n]):t[n]);return e}},s={compile:function(t){return e.prototype.Handlebars.compile(t)},registerPartial:function(t){const n=Object.entries(t);for(var l=0,o=n.length;l<o;l++)e.prototype.Handlebars.registerPartial(n[l][0]+"-block",n[l][1])}};return s.registerPartial({badge:'<span class="badge">{{count}}</span>',icon:'{{#if icon}}<span class="{{icon}} {{classes}} flb-cart-icon"></span>{{/if}}',label:"{{#if label}}{{label}}{{/if}}"}),e.prototype.Handlebars.registerHelper({cut:function(e,t){const n=t.fn(this);return 0===n.indexOf(e)?n.substring(e.length):n},truncate:function(t,n){const l=n.fn(this);if(l&&l.length>t&&l.length>0){var o=l+" ";return o=l.substr(0,t),o=(o=l.substr(0,o.lastIndexOf(" "))).length>0?o:l.substr(0,t),new e.prototype.Handlebars.SafeString(o+"...")}return l},list:function(e,t){const n=t.hash.delimiter||"|",l=t.hash.joinWith||"";return e.split(n).map(e=>t.fn(e)).join(l)}}),e}();